<!-- 
    Feature to do:
    1. color bubble with region.
    2. Initial page with first graph open
    3. Speed up button
    4. Automatic select for left box.
 -->
<!DOCTYPE html>
<html lang="en">
<style>
    /* Reference: http://bl.ocks.org/d3noob/a22c42db65eb00d4e369 */
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 70px;
        height: 50px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>

<head>
    <meta charset="utf-8">
    <title>Solutions</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.js"></script>
</head>

<!-- Jonathan and Ernestas body Bootstrap START -->

<body style="background-color: aliceblue">

    <!-- NOTE: Many of the bootstrap components used in this assignment are adaptions from: https://getbootstrap.com/docs/3.3/components/ -->

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#" style="font-size: 14px;">
                    <b>Channeling Hans </b> by Jonathan Leon, Xinyue Wang and Ernestas Monkevicius &nbsp

                    <button type="button" class="btn btn-danger btn-md" data-toggle="collapse" data-target="#visualizationControl"
                        id="mainVisualizationDisplayButton">
                        <p>Hide Main Visualisation</p>
                    </button>

                </a>
            </div>
    </nav>

    <div class="container">
        <p id="hans">
            <!-- Error message goes here-->
        </p>

        <div class="row">
            <div class="col-xs-12">
                <div id="visualizationControl" class="collapse in">
                    <br />
                    <div class="row">
                        <div class="col-xs-4">
                            <h3 id="year_header" style="margin-top: 0;">Year: 2007</h3>
                        </div>
                        <div class="col-xs-8">
                            <!-- Split button for choosing country and showing it's trace -->
                            <input list="countryDropDown" name="browser" id="countryDropDownInput" placeholder="Select Country Here">
                            <datalist id="countryDropDown">
                                <!-- list items indicating countries will be inserted here after reading in data from .csv -->
                                <!--e.g. <option value="Ireland"> -->
                                <!--e.g. <option value="Ireland"> -->
                            </datalist>

                            <button type="button" class="btn btn-primary" id="showTraceButton"><span>Show Trace</span></button>
                            <button class="btn btn-info" data-toggle="popover" title="Show Trace on the Main Visualisation"
                                data-content="Show each of the historic positions of the selected country from 2007 to the currently displayed year on the graph."
                                data-placement="top" data-trigger="focus">?</button>
                        </div>
                    </div>

                    <h2 id="g1"></h2>
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-xs-2">
                <button type="button" class="btn btn-success" id="playPauseButton"><span class="glyphicon glyphicon-play"></span><br />
                    <p>Play</p>
                </button>
            </div>
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-xs-1">
                        <!-- space -->
                    </div>
                    <div class="col-xs-1">
                        2007
                    </div>
                    <div class="col-xs-1">
                        2008
                    </div>
                    <div class="col-xs-1">
                        2009
                    </div>
                    <div class="col-xs-1">
                        2010
                    </div>
                    <div class="col-xs-1">
                        2011
                    </div>
                    <div class="col-xs-1">
                        2012
                    </div>
                    <div class="col-xs-1">
                        2013
                    </div>
                    <div class="col-xs-1">
                        2014
                    </div>
                    <div class="col-xs-1">
                        2015
                    </div>
                    <div class="col-xs-1">
                        2016
                    </div>
                    <div class="col-xs-1">
                        2017
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-1">
                        <!-- space -->
                    </div>
                    <div class="col-xs-11">
                        <div data-role="main" class="ui-content">
                            <form method="post">
                                <label for="yearSlider">Year:</label>
                                <input type="range" name="yearSlider" id="yearSlider" value="2007" min="2007" max="2017">
                            </form>
                        </div>
                    </div>
                </div>
                <br />
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <button type="button" class="btn btn-success" data-toggle="collapse" data-target="#gciVisualizationControl"
                    id="gciVisualizationDisplayButton">
                    <p>Show Pillars of Global Competitiveness Index (GCI)</p>
                </button>
                <br />
                <div id="gciVisualizationControl" class="collapse in">
                    <!-- Second visualization will go here-->
                    <h2 id="g2"></h2>

                    <br />
                    <div class="row">
                        <div class="col-xs-12">
                            <h4>You may view the 12 pillars of Global Competitiveness Index (GCI) of one or two
                                countries. If two countries are
                                viewed simulatnously, their GCI values will be directly compared against each others.
                            </h4>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6">
                            <input list="countryDropDown" name="browser" id="countryDropDownInputLeft" placeholder="Select Country One">
                            <datalist id="countryDropDown">
                                <!-- list items indicating countries will be inserted here after reading in data from .csv -->
                                <!--e.g. <option value="Ireland"> -->
                                <!--e.g. <option value="Ireland"> -->
                            </datalist>

                            <button type="button" class="btn btn-primary" id="showPillarsButtonLeft"><span>View</span></button>
                            <button class="btn btn-info" data-toggle="popover" title="Pillars of the Global	Competitiveness Index (GCI)"
                                data-content="View the 12 pillars of the GCI for the selected country." data-placement="top"
                                data-trigger="focus">?</button>
                        </div>

                        <div class="col-xs-6">
                            <input list="countryDropDown" name="browser" id="countryDropDownInputRight" placeholder="Select Country Two">
                            <datalist id="countryDropDown">
                                <!-- list items indicating countries will be inserted here after reading in data from .csv -->
                                <!--e.g. <option value="Ireland"> -->
                                <!--e.g. <option value="Ireland"> -->
                            </datalist>

                            <button type="button" class="btn btn-primary" id="showPillarsButtonRight"><span>View</span></button>
                            <button class="btn btn-info" data-toggle="popover" title="Pillars of the Global	Competitiveness Index (GCI)"
                                data-content="View the 12 pillars of the GCI for the selected country." data-placement="top"
                                data-trigger="focus">?</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Jonathan and Ernestas body Bootstrap END -->

    <script>
        //Initialize the tooltips
        $(document).ready(function () {
            $('[data-toggle="popover"]').popover();
        });

        //initial state of the visualization animation
        let playing = false;
        //assigning callbacks to play/pause button
        $("#playPauseButton").on("click", function () {
            //let rows = $('#...').val();
            playing = !playing;
            if (playing) {
                $('#playPauseButton').addClass('btn-danger').removeClass('btn-success');
                $('#playPauseButton span').addClass('glyphicon-pause').removeClass('glyphicon-play');
                $('#playPauseButton p').text("Pause");
                // if (showingTrace) leaveTrace
            } else {
                $('#playPauseButton').addClass('btn-success').removeClass('btn-danger');
                $('#playPauseButton span').addClass('glyphicon-play').removeClass('glyphicon-pause');
                $('#playPauseButton p').text("Play");
            }
            // console.log("Play/Pause Button state:: is playing? "+playing); //TESTING
        });

        // ===========================
        // Drop down box to show trace
        // ===========================
        var showingTrace = false;
        var country = "";
        //assign callback to show trace button
        $("#showTraceButton").on("click", function () {
            country = $('#countryDropDownInput').val();

            //if not input, just return
            if (country == "" && !showingTrace) return;

            showingTrace = !showingTrace;
            if (showingTrace) {
                $('#showTraceButton').addClass('btn-danger').removeClass('btn-primary');
                $('#showTraceButton span').text("Hide Trace");
            } else {
                $('#showTraceButton').addClass('btn-primary').removeClass('btn-danger');
                $('#showTraceButton span').text("Show Trace");
            }

            generateVis(dataset, false);

            //console.log("Show Trace Button state:: is showing trace? "+showingTrace); //TESTING
        });

        //initial state of the visualization display
        let showingMainVisualization = true;
        //assigning callbacks to button
        $("#mainVisualizationDisplayButton").on("click", function () {
            //let rows = $('#...').val();
            showingMainVisualization = !showingMainVisualization;
            if (showingMainVisualization) {
                $('#mainVisualizationDisplayButton').addClass('btn-danger').removeClass('btn-success');
                $('#mainVisualizationDisplayButton p').text("Hide Main Visualisation");
            } else {
                $('#mainVisualizationDisplayButton').addClass('btn-success').removeClass('btn-danger');
                $('#mainVisualizationDisplayButton p').text("Show Main Visualisation");
            }
            console.log("Show Visualization Button state:: is showing? " + showingMainVisualization); //TESTING
        });

        //initial state of the visualization display
        //let showingGCIVisualization = false;
        let showingGCIVisualization = true;
        //assigning callbacks to button
        $("#gciVisualizationDisplayButton").on("click", function () {
            //let rows = $('#...').val();
            showingGCIVisualization = !showingGCIVisualization;
            if (showingGCIVisualization) {
                $('#gciVisualizationDisplayButton').addClass('btn-danger').removeClass('btn-success');
                $('#gciVisualizationDisplayButton p').text("Hide Pillars of Global Competitiveness Index (GCI)");
            } else {
                $('#gciVisualizationDisplayButton').addClass('btn-success').removeClass('btn-danger');
                $('#gciVisualizationDisplayButton p').text("Show Pillars of Global Competitiveness Index (GCI)");
            }
            console.log("Show GCI Visualization Button state:: is showing? " + showingGCIVisualization); //TESTING
        });


        let showPillarsButtonLeftClicked = false;
        let showPillarsButtonRightClicked = false;
        //assign callback to button
        $("#showPillarsButtonLeft").on("click", function () {
            //after first click always true as there's no way to "clear" a visualization
            showPillarsButtonLeftClicked = true;
            let comparing = showPillarsButtonRightClicked; //both left and right view buttons have been clicked...

            let country = $('#countryDropDownInputLeft').val();

            //if not input, just return
            if (country == "") return;

            //showGCIpillars(country, comparing); //Show the GCI pillars for this country and compare with other if needed

            console.log("showPillarsButtonLeft:: is showing trace? " + country); //TESTING
        });

        //assign callback to button
        $("#showPillarsButtonRight").on("click", function () {
            //after first click always true as there's no way to "clear" a visualization
            showPillarsButtonRightClicked = true;
            let comparing = showPillarsButtonLeftClicked; //both left and right view buttons have been clicked...

            let country = $('#countryDropDownInputRight').val();

            //if not input, just return
            if (country == "") return;

            //showGCIpillars(country, comparing); //Show the GCI pillars for this country and compare with other if needed

            console.log("showPillarsButtonRight:: is showing trace? " + country); //TESTING
        });

        // The year to display
        let display_year = 2007;
        let dataset = {};
        let reversedDataset = {};

        document.getElementById("yearSlider").oninput = function () {
            console.log("Year Slider:: value -> " + this.value); //TESTING
            display_year = +this.value;
            generateVis(dataset, false);
            generateVisForPillars(dataset);
        };

        //define input file
        let file = "GCI_CompleteData3.csv";

        // Define margins
        var margin = { top: 10, right: 10, bottom: 45, left: 55 };

        //Width and height
        var outer_width = 1100;
        var outer_height = 450;
        var svg_width = outer_width - margin.left - margin.right;
        var svg_height = outer_height - margin.top - margin.bottom;

        // define a function that filters data by year
        function yearFilter(value) {
            return (value.Year == display_year)
        }
        
        function countryAndYearFilter0 (value) {
            return yearFilter(value) && value.Country == country;
        }

        //country to filter for
        function countryAndYearFilter(value) {
            return value.Country == country && +value.Year <= +display_year;
        };

        //Create Main SVG element as a group with the margins transform applied to it
        var svg = d3.select("#g1")
            .append("svg")
            .attr("width", svg_width + margin.left + margin.right)
            .attr("height", svg_height + margin.top + margin.bottom)
            .style("background", "white")
            //.style("width", "80vw")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        //.style("fill", "white");


        //-- Wang and Ernestas Main Graph Axes START --//
        // Create linear Y scale for Global Competitive Index
        var yScale = d3.scaleLinear()
            .domain([0, 7])
            .range([svg_height, 0]);

        //Create logarithmic X scale for the GPD
        var xScale = d3.scaleLog()
            .domain([100, 2.4e6])
            .range([0, svg_width]);

        //Define Y axis
        var yAxis = d3.axisLeft()
            .scale(yScale)
            .ticks(5)
            .tickFormat(d3.format(".0s"));

        // Create an x-axis connected to the x scale
        var xAxis = d3.axisBottom()
            .scale(xScale)
            // .tickFormat(d3.format(".0s"))
            .ticks(10, ".0s");

        // Define the div for the tooltip
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Call the y axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "y-axis")
            .call(yAxis);

        // All but call the x-axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "x-axis")
            .attr("transform", "translate(0," + svg_height + ")")
            .call(xAxis);

        // text label for the x axis
        svg.append("text")
            .attr("transform",
                "translate(" + (outer_width / 2) + " ," +
                (svg_height + margin.top + 30) + ")")
            .style("text-anchor", "middle")
            .text("GDP");

        // text label for the y axis
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (svg_height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Global Competitive Index");

        //-- Wang and Ernestas Main Graph Axes END --//

        // Define a fucntion to draw a simple bar chart
        //-- Wang and Ernestas Main Graph START --//
        function generateVis(data, advanceTime = false) {
            //advance the time forward and set the year label
            if (advanceTime) {
                if (display_year + 1 > 2017) {
                    display_year = 2007;
                } else {
                    display_year = display_year + 1;
                }
            }

            // Filter the data to only include the current year
            var filtered_datset = data.filter(yearFilter);

            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            /******** PERFORM DATA JOIN ************/
            // Join new data with old elements, if any.
            var points = svg.selectAll("circle")
                .data(filtered_datset, function key(d) {
                    return d.Country;
                });

            /******** HANDLE UPDATE SELECTION ************/
            // Update the display of existing elelemnts to match new data
            // Perform a data join and add points to the chart
            points
                .style("opacity", function (d) {
                    if (showingTrace && display_year == 2007) return (d.Country === country) ? 1 : .1; //on 2007 year we need to see the trace country
                    if (showingTrace) return (d.Country === country) ? 0 : .1; //after 2007, the ShowingTrace Update Patter below will take care of it
                    else return 1;
                })
                .transition()
                .duration(1000)
                .attr("cx", function (d) {
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .attr("r", function (d) {
                    //Divide 90000 since the smallest country's population is so.
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;
                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "green" : "orange";
                })
                .style("stroke", function (d) {
                    return "black";
                });


            // ===========================
            // ShowingTrace Update Pattern
            // ===========================
            if (showingTrace) {
                country = $('#countryDropDownInput').val();
                let selectedCountryInfo = reversedDataset.filter(countryAndYearFilter);
                console.log(selectedCountryInfo);
                //let selectedCountryInfo = data.filter(countryAndYearFilter);

                let pointsTrace = svg.selectAll("circle")
                    .data(selectedCountryInfo, function key(d) {
                        return d.Country;
                    });

                //svg.selectAll("#"+country).remove();

                let enterTrace = pointsTrace.enter()
                    .append("circle")
                    .attr("id", function (d) {
                        console.log(d.Year); //TESTING
                        return d.Country;
                    })
                    .attr("cx", function (d) {
                        // console.log(d.GDP);
                        return d.GDP ? xScale(+d.GDP) : margin.left;
                    })
                    .attr("cy", function (d) {
                        return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                    })
                    .attr("r", function (d) {
                        //Divide 90000 since the smallest country's population is so.
                        if (d.Population) {
                            let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                            return circleArea;
                        } else return 0;
                    })
                    .style("fill", function (d) {
                        return d.Global_Competitiveness_Index ? "green" : "orange";
                    })
                    .style("stroke", "black")
                    .style("opacity", function (d) {
                        //if (showingTrace) return d.Country == country ? 1 : .1;
                        //else return 1;
                        return 1;
                    });
            }

            /******** HANDLE ENTER SELECTION ************/
            // Create new elements in the dataset
            // Perform a data join and add points to the chart
            var enter = points.enter()
                .append("circle")
                .attr("id", function (d) {
                    return d.Country;
                })
                .attr("cx", function (d) {
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(d.Country + "<br>" + d.Population)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
                .style("opacity", function (d) {
                    if (showingTrace) return d.Country == country ? 1 : .1;
                    else return 1;
                });

            enter.transition()
                .duration(1000)
                .ease(d3.easeBounce)
                .attr("r", function (d) {
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;
                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "blue" : "orange";
                })
                .style("stroke", "black");



            /******** HANDLE EXIT SELECTION ************/
            // Remove elements that not longer have a matching data element
            points.exit()
                .style("fill", "red")
                .transition()
                .duration(1000)
                .attr("r", 0)
                .remove();

            d3.select("#year_header").text("Year: " + display_year);
        }
        //-- Wang and Ernestas Main Graph END --//


        //-- Jonathan and Wang Graph Legend START --//
        //Add legend frame
        var legend_margin = { top: 10, right: 10, bottom: 10, left: 10 };
        var rect_width = svg_width * 0.2;
        var rect_height = svg_height * .2;
        var gap = 10;
        svg.append("rect")
            .attr("x", svg_width - rect_width)
            .attr("y", 0)
            .attr("width", rect_width)
            .attr("height", rect_height)
            .style("fill", "lightsteelblue")
            .style("opacity", .9);

        //Add legend rects and Text
        var legend_circle_r = svg_width * 0.01;
        svg.append("rect")
            .attr("id", "blue")
            .attr("x", svg_width - rect_width + legend_margin.left)
            .attr("y", legend_margin.top)
            .attr("width", legend_circle_r)
            .attr("height", legend_circle_r)
            .style("fill", "blue");

        svg.append("rect")
            // .attr("id","blue")
            .attr("x", svg_width - rect_width + legend_margin.left)
            .attr("y", legend_margin.top + gap + legend_circle_r)
            .attr("width", legend_circle_r)
            .attr("height", legend_circle_r)
            .style("fill", "green");

        svg.append("rect")
            // .attr("id","blue")
            .attr("x", svg_width - rect_width + legend_margin.left)
            .attr("y", legend_margin.top + 2 * (gap + legend_circle_r))
            .attr("width", legend_circle_r)
            .attr("height", legend_circle_r)
            .style("fill", "orange");

        svg.append("rect")
            // .attr("id","blue")
            .attr("x", svg_width - rect_width + legend_margin.left)
            .attr("y", legend_margin.top + 3 * (gap + legend_circle_r))
            .attr("width", legend_circle_r)
            .attr("height", legend_circle_r)
            .style("fill", "red");

        svg.append("text")
            .attr("transform",
                "translate(" + (svg_width - rect_width + legend_margin.left + legend_circle_r + gap) + " ," +
                (legend_margin.top + 10) + ")")
            // .style("text-anchor", "middle")
            .text("New Enter");

        svg.append("text")
            .attr("transform",
                "translate(" + (svg_width - rect_width + legend_margin.left + legend_circle_r + gap) + " ," +
                (legend_margin.top + 10 + gap + legend_circle_r) + ")")
            // .style("text-anchor", "middle")
            .text("Update");

        svg.append("text")
            .attr("transform",
                "translate(" + (svg_width - rect_width + legend_margin.left + legend_circle_r + gap) + " ," +
                (legend_margin.top + 2 * (gap + legend_circle_r) + 10) + ")")
            // .style("text-anchor", "middle")
            .text("Missing Value");

        svg.append("text")
            .attr("transform",
                "translate(" + (svg_width - rect_width + legend_margin.left + legend_circle_r + gap) + " ," +
                (legend_margin.top + 3 * (gap + legend_circle_r) + 10) + ")")
            // .style("text-anchor", "middle")
            .text("Exiting");
        //-- Jonathan and Wang Graph Legend END --//


        //-- Ernestas and Jonathan File Loading START --//
        // Load the file data.csv and generate a visualisation based on it
        d3.csv(file).then(function (data) {
            //console.log(data); //TESTING
            dataset = data;
            reversedDataset = data.slice(0).reverse();
            //handle the loaded data
            handleData(dataset);
        }, function (error) {
            console.log("Error Loading data!");
            console.log(error);
            document.getElementById("hans").innerHTML += "<br/><span style=\"color: red;\"> Error Loading Data! Please check that " + file + " is present in the same directory as this html file. <br/><br/> The " + file + " was included with the submission of this assignmnet.<br/><br/> Please note that GCI_CompleteData2.csv may NOT be used! <br/><br/> Both " + file + " and GCI_CompleteData2.csv have the same contents, however the rows in " + file + " have been order based on country population and this visualization relies on this ordering.</span>";
        });

        function handleData(dataset) {
            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            createXAxisForPillars(dataset);

            // Generate the initial visualisation
            generateVis(dataset);

            if (showingGCIVisualization) {
                // console.log("Showing GCI!!")
                generateVisForPillars(dataset);
            }
            //Populate the country drop down
            populateCountryTraceDropdown(dataset);

            //setTimeout() runs only ONCE as oppose to setInterval() which loops automatically
            //since we want to control playback ourselves, we can't use setInterval()
            setInterval(function () {

                if (playing) {
                    generateVis(dataset, true);
                    document.getElementById("yearSlider").value = display_year;

                    if (showingGCIVisualization) {
                        // console.log("Showing GCI!!")
                        generateVisForPillars(dataset);
                    }
                }


            }, 2000);
        }
        //-- Ernestas and Jonathan File Loading END --//

        function populateCountryTraceDropdown(data) {
            let countrySet = new Set();

            _.forEach(data, function (row) {
                countrySet.add(row.Country); //Add each country to a set
            });

            for (let country of countrySet) {
                let countryDropDownUL = document.getElementById("countryDropDown");
                let option = document.createElement('option')
                option.setAttribute("value", country);

                countryDropDownUL.appendChild(option);
            };
        }

        // Header of csv: Country,Year,1st_pillar_Institutions,2nd_pillar_Infrastructure,
        // 3rd_pillar_Macroeconomic_environment,4th_pillar_Health_and_primary_education,
        // 5th_pillar_Higher_education_and_training,6th_pillar_Goods_market_efficiency,
        // 7th_pillar_Labor_market_efficiency,8th_pillar_Financial_market_development,
        // 9th_pillar_Technological_readiness,10th_pillar_Market_size,11th_pillar_Business_sophistication_,
        // 12th_pillar_Innovation,Global_Competitiveness_Index,Population,GDP,Income group,Region,
        // Forum classification


        //Create GCI SVG element as a group with the margins transform applied to it
        var xAxis0;
        var xScale0;
        var svgGCI = d3.select("#g2")
            .append("svg")
            .attr("width", svg_width + margin.left + margin.right)
            .attr("height", svg_height + margin.top + margin.bottom)
            .style("background", "white")
            //.style("width", "80vw")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Create a scale to scale market share values nicely for bar heights
        // var yScale0 = d3.scaleLinear()
        //     .domain([0, 10])
        //     .range([svg_height, 0]);
        
        var x = [];

        function createXAxisForPillars (dataset) {
            var columns = dataset.columns;
            // console.log(columns);    
            for (i = 0; i < columns.length; i++) {
                // console.log(columns[i].includes("pillar"));
                if (columns[i].includes("pillar"))
                    x.push(columns[i].split('_')[2]);
            }

            // console.log(x);

            // Create a scale object to nicely take care of positioning bars along the horizontal axis
            // We don't set the domain yet as data isn't loaded
            xScale0 = d3.scaleBand()
                //.rangeBands([0, 500], 1)
                //.domain(x.map(function (d) { return d; }))
                .domain(x)
                .rangeRound([0, svg_width], 0.1)
                .paddingInner(0.05);
            
            // Create an x-axis connected to the x scale
            xAxis0 = d3.axisBottom()
                .scale(xScale0)
                // .tickFormat(d3.format(".0s"))
                .ticks(10, ".0s");
        }
        
        // var yAxis0 = d3.axisLeft()
        //     .scale(yScale)
        //     .ticks(5)
        //     .tickFormat(d3.format(".0s"))
        //     ;

        // Call the y axis
        svgGCI.append("g")
            .attr("class", "axis")
            .attr("id", "y-axis")
            .call(yAxis);

        // All but call the x-axis
        svgGCI.append("g")
            .attr("class", "axis")
            .attr("id", "x-axis0")
            .attr("transform", "translate(0," + svg_height + ")");

        

        // Define a fucntion to draw a simple bar chart
        function generateVisForPillars(dataset) {
            country = $('#countryDropDownInputLeft').val();
            // Filter the data to only include the current year
            var filtered_datset = dataset.filter(countryAndYearFilter0);

            let twelveColumns = [];
            if (typeof filtered_datset[0] !== 'undefined'){
                twelveColumns = Object.entries(filtered_datset[0]).slice(2,14);
                console.log(twelveColumns);
                filtered_datset = twelveColumns;
            }

            // Update the domain of the x scale
            // xScale.domain(filtered_datset.map(function (d) { return d.Company; }));
            // Call the x-axis
            svgGCI.select("#x-axis0").call(xAxis0)
            ;
            // console.log(x);
            /******** PERFORM DATA JOIN ************/
            // Join new data with old elements, if any.
            var bars = svgGCI.selectAll("rect")
                .data(filtered_datset, function key(d) {
                    return d;
                });
            
            // console.log(bars);
            /******** HANDLE UPDATE SELECTION ************/
            // Update the display of existing elelemnts to mathc new data
            let columnX = 0;
            bars
                .transition()
                .duration(1000)
                .ease(d3.easeQuad)
                .attr("x", function (d, i) {
                    return xScale0(d[0].split('_')[2]);
                })
                .attr("y", function (d) {
                    return yScale(+d[1]);
                })
                .attr("width", xScale0.bandwidth())
                .attr("height", function (d) {
                    return svg_height - yScale(+d[1]);
                })
                .style("fill", "Green");


            /******** HANDLE ENTER SELECTION ************/
            // Create new elements in the dataset
            bars.enter()
                .append("rect")
                .attr("x", function (d, i) {
                    return xScale0(d[0].split('_')[2]);
                })
                .attr("y", function (d) {
                    return svg_height;
                })
                .attr("width", xScale0.bandwidth())
                .attr("height", 0)
                .transition()
                .duration(1000)
                .ease(d3.easeQuad)
                .attr("y", function (d) {
                    console.log(d[1]);
                    return yScale(+d[1]);
                })
                .attr("height", function (d) {
                    return svg_height - yScale(+d[1]);
                })
                .style("fill", "Blue");

            /******** HANDLE EXIT SELECTION ************/
            // Remove bars that not longer have a matching data eleement
            bars.exit()
                .transition()
                .duration(1000)
                .ease(d3.easeQuad)
                .attr("width", 0)
                .style("fill", "Red")
                .remove();

            // Set the year label
            //d3.select("#year_header").text("Year: " + display_year)

        }



    </script>
</body>

</html>