<!DOCTYPE html>
<html lang="en">
<style>
    /* Reference: http://bl.ocks.org/d3noob/a22c42db65eb00d4e369 */
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 65px;
        height: 40px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>

<head>
    <meta charset="utf-8">
    <title>Solutions</title>
    <script src="https://d3js.org/d3.v5.js"></script>
</head>

<body style="background-color: aliceblue">

    <!-- BODY -->
    <h1 id="hans">Channeling Hans</h1>
    <h3 id="year_header">Year: 2007</h3>
    <h2 id="g1"></h2>

    <script>
        // Define margins
        var margin = { top: 10, right: 10, bottom: 45, left: 45 };

        //Width and height
        var outer_width = 1200;
        var outer_height = 500;
        var svg_width = outer_width - margin.left - margin.right;
        var svg_height = outer_height - margin.top - margin.bottom;

        // The year to display
        display_year = 2007;

        // define a function that filters data by year
        function yearFilter(value) {
            return (value.Year == display_year)
        }

        //Create SVG element as a group with the margins transform applied to it
        var svg = d3.select("#g1")
            .append("svg")
            .attr("width", svg_width + margin.left + margin.right)
            .attr("height", svg_height + margin.top + margin.bottom)
            //.style("fill", "white")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        //.style("fill", "white");

        //Add legend frame
        // var legend_margin = { top: 10, right: 10, bottom: 10, left: 10 };
        // var rect_width = svg_width*0.2;
        // var rect_height = svg_height*.2;
        // svg.append("rect")
        // .attr("x", svg_width-rect_width)
        // .attr("y", 0)
        // .attr("width", rect_width)
        // .attr("height", rect_height)
        // .style("fill", "lightsteelblue")
        // .style("opacity",.9)
        // ;
        // //Add circles and Text
        // var legend_circle_r = svg_width*0.05;
        // svg.append("circle")
        // .attr("cx", svg_width-rect_width+legend_margin.left)
        // .attr("cy", legend_margin.top)
        // .attr("r", legend_circle_r)
        // .style("fill", "blue")
        // ;

        // Create linear Y scale for Global Competitive Index
        var yScale = d3.scaleLinear()
            .domain([0, 7])
            .range([svg_height, 0]);

        //Create logarithmic X scale for the GPD
        var xScale = d3.scaleLog()
            .domain([100, 2.4e6])
            .range([0, svg_width]);

        //Define Y axis
        var yAxis = d3.axisLeft()
            .scale(yScale)
            .ticks(5)
            .tickFormat(d3.format(".0s"))
            ;

        // Create an x-axis connected to the x scale
        var xAxis = d3.axisBottom()
            .scale(xScale)
            // .tickFormat(d3.format(".0s"))
            .ticks(10, ".0s")
            ;

        // Define the div for the tooltip
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Call the y axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "y-axis")
            .call(yAxis);

        // All but call the x-axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "x-axis")
            .attr("transform", "translate(0," + svg_height + ")")
            .call(xAxis)
            ;

        // text label for the x axis
        svg.append("text")
            .attr("transform",
                "translate(" + (outer_width / 2) + " ," +
                (svg_height + margin.top + 30) + ")")
            .style("text-anchor", "middle")
            .text("GDP");

        // text label for the y axis
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (svg_height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Global Competitive Index");

        // Define a fucntion to draw a simple bar chart
        function generateVis() {

            // Filter the data to only include the current year
            var filtered_datset = dataset.filter(yearFilter);

            // Update the domain of the x scale
            //xScale.domain(filtered_datset.map(function(d) { return d.Company; }));

            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            /******** PERFORM DATA JOIN ************/
            // Join new data with old elements, if any.
            /*var bars = 	svg.selectAll("rect")
           .data(filtered_datset, function key(d) {
                                    return d.Company;
                                });*/

            var points = svg.selectAll("circle")
                .data(filtered_datset, function key(d) {
                    return d.Country;
                });

            /******** HANDLE UPDATE SELECTION ************/
            // Update the display of existing elelemnts to match new data
            // Perform a data join and add points to the chart
            points
                .transition()
                .duration(2000)
                .attr("cx", function (d) {
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .attr("r", function (d) {
                    //Divide 90000 since the smallest country's population is so.
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;

                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "green" : "orange";
                })
                .style("stroke", "black")
                ;
            // .on("mouseover", function (d) {
            //     div.transition()
            //         .duration(200)
            //         .style("opacity", .9);
            //     div.html(d.Country)
            //         .style("left", (d3.event.pageX) + "px")
            //         .style("top", (d3.event.pageY - 28) + "px");
            // })
            // .on("mouseout", function (d) {
            //     div.transition()
            //         .duration(500)
            //         .style("opacity", 0);
            // });


            /******** HANDLE ENTER SELECTION ************/
            // Create new elements in the dataset
            // Perform a data join and add points to the chart
            var enter = points.enter()
                .append("circle")
                .attr("cx", function (d) {
                    // console.log(d.GDP);
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(d.Country + "<br>" + d.Population)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            enter.transition()
                .duration(2000)
                .ease(d3.easeBounce)
                .attr("r", function (d) {
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;
                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "blue" : "orange";
                })
                .style("stroke", "black");
            //.attr("r", 6);



            /******** HANDLE EXIT SELECTION ************/
            // Remove elements that not longer have a matching data eleement
            points.exit()
                .style("fill", "red")
                .transition()
                .duration(2000)
                .attr("r", 0)
                .remove();

            // Set the year label
            d3.select("#year_header").text("Year: " + display_year)

        }

        // Load the file data.csv and generate a visualisation based on it
        // d3.csv("GCI_CompleteData2.csv").then(function(data){
        d3.csv("GCI_CompleteData3.csv").then(function (data) {

            console.log(data); //TESTING

            // Assign  the data object loaded to the global dataset variable
            dataset = data;

            // Update the domain of the x scale
            //xScale.domain(dataset.map(function(d) { return d.GDP; }));
            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            // Generate the visualisation
            generateVis();

            // Iterate through our avilable years.
            setInterval(function () {
                display_year = display_year + 1;
                if (display_year > 2017) {
                    display_year = 2007;
                }
                generateVis();
            }, 4000);
        }, function (error) {
            console.log("Error Loading data!");
            console.log(error);
            document.getElementById("hans").innerHTML += "<span style=\"color: red;\"> Error Loading Data! Please check that GCI_CompleteData2.csv is present in the same directory as this html file.</span>";
        });
    
        //Add legend frame
        var legend_margin = { top: 10, right: 10, bottom: 10, left: 10 };
        var rect_width = svg_width*0.2;
        var rect_height = svg_height*.2;
        var gap = 10;
        svg.append("rect")
        .attr("x", svg_width-rect_width)
        .attr("y", 0)
        .attr("width", rect_width)
        .attr("height", rect_height)
        .style("fill", "lightsteelblue")
        .style("opacity",.9)
        ;
        //Add circles and Text
        var legend_circle_r = svg_width*0.01;
        svg.append("rect")
        .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top)
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "blue")
        ;

        svg.append("rect")
        // .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top+gap+legend_circle_r)
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "green")
        ;

        svg.append("rect")
        // .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top+2*(gap+legend_circle_r))
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "orange")
        ;
        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+10) + ")")
            // .style("text-anchor", "middle")
            .text("New Enter");

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+10+gap+legend_circle_r) + ")")
            // .style("text-anchor", "middle")
            .text("Update");

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+2*(gap+legend_circle_r)+10) + ")")
            // .style("text-anchor", "middle")
            .text("Missing Value");

    </script>
</body>

</html>