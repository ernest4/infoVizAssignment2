
<!DOCTYPE html>
<html lang = "en">
	<head>
		<meta charset="utf-8">
		<title>Solutions</title>
		<script src="https://d3js.org/d3.v5.js"></script>
	</head>
    <body style="background-color: aliceblue">
        
        <!-- BODY -->
        <h1 id="hans">Channeling Hans</h1>
        <h3 id = "year_header">Year: 2013</h3>
        <h2 id="g1"></h2>

        <script>
            // Define margins
			var margin = {top: 10, right: 10, bottom: 25, left: 25};
			
			//Width and height
			var outer_width = 900;
			var outer_height = 500;
			var svg_width = outer_width - margin.left - margin.right;
			var svg_height = outer_height - margin.top - margin.bottom;

			// The year to display
			display_year = 2007;
			
			// define a function that filters data by year
			function yearFilter(value){
				return (value.Year == display_year)
			}
			
			//Create SVG element as a group with the margins transform applied to it
			var svg = d3.select("#g1")
						.append("svg")
						.attr("width", svg_width + margin.left + margin.right)
						.attr("height", svg_height + margin.top + margin.bottom)
                        //.style("fill", "white")
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                        //.style("fill", "white");
			
			// Create linear Y scale for Global Competitive Index
			var yScale = d3.scaleLinear()
				                     .domain([2.5, 6])
				                     .range([svg_height, 0]);

            //Create logarithmic X scale for the GPD
			var xScale = d3.scaleLog()
                            .domain([100, 2000000])
                            .range([0, svg_width]);
						
			//Define Y axis
			var yAxis = d3.axisLeft()
							  .scale(yScale)
							  .ticks(5);
			
			// Create an x-axis connected to the x scale
			var xAxis = d3.axisBottom()
						 .scale(xScale)
                         .ticks(5);
						  
			// Call the y axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "y-axis")
				.call(yAxis);
					
			// All but call the x-axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "x-axis")
				.attr("transform", "translate(0," + svg_height + ")");
					
			// Define a fucntion to draw a simple bar chart
			function generateVis(){
					
				// Filter the data to only include the current year
				var filtered_datset = dataset.filter(yearFilter);

				// Update the domain of the x scale
				//xScale.domain(filtered_datset.map(function(d) { return d.Company; }));

				// Call the x-axis
				svg.select("#x-axis").call(xAxis);
					
			 	/******** PERFORM DATA JOIN ************/
			  	// Join new data with old elements, if any.
			  	/*var bars = 	svg.selectAll("rect")
				   .data(filtered_datset, function key(d) {
											return d.Company;
										});*/

                var points = svg.selectAll("circle")
							.data(filtered_datset, function key(d) {
											return d.Country;
										});
			
			 	/******** HANDLE UPDATE SELECTION ************/
                // Update the display of existing elelemnts to match new data
                // Perform a data join and add points to the chart
                points
                        .transition()
                        .duration(2000)
                        .attr("cx", function(d){
                            return xScale(+d.GDP);
                        })
                        .attr("cy", function(d){
                            return yScale(+d.Global_Competitiveness_Index);
                        })
                        .attr("r", function(d){
                            let circleArea = Math.sqrt((+d.Population/Math.PI)/90000);
                            return circleArea;
                        })
                        .style("fill", "green")
                        .style("stroke", "black");


                /******** HANDLE ENTER SELECTION ************/
                // Create new elements in the dataset
                // Perform a data join and add points to the chart
                points.enter()
                    .append("circle")
                        .attr("cx", function(d){
                            return xScale(+d.GDP);
                        })
                        .attr("cy", function(d){
                            return yScale(+d.Global_Competitiveness_Index);
                        })
                        .attr("r", function(d){
                            let circleArea = Math.sqrt((+d.Population/Math.PI)/90000);
                            return circleArea;
                        })
                        .style("fill", "blue")
                        .style("stroke", "black")
                        .transition()
                        .duration(2000)
                        .ease(d3.easeBounce)
                        .attr("r", 6);

                
            
                /******** HANDLE EXIT SELECTION ************/
                // Remove elements that not longer have a matching data eleement
                points.exit()
                        .style("fill", "red")
                        .transition()
                        .duration(2000)
                        .attr("r", 0)
                        .remove();
			  		
				// Set the year label
				d3.select("#year_header").text("Year: " + display_year)
  
			}

			// Load the file data.csv and generate a visualisation based on it
			d3.csv("GCI_CompleteData2.csv").then(function(data){
					
                console.log(data); //TESTING

                // Assign  the data object loaded to the global dataset variable
                dataset = data;
                
                // Update the domain of the x scale
                //xScale.domain(dataset.map(function(d) { return d.GDP; }));
                // Call the x-axis
                svg.select("#x-axis").call(xAxis);

                // Generate the visualisation
                generateVis();

                // Iterate through our avilable years.
                setInterval(function() {
                    display_year = display_year + 1;
                    if(display_year > 2017){
                        display_year = 2007;
                    }
                    generateVis();
                }, 4000);
			}, function(error){
                console.log("Error Loading data!");
                console.log(error);
                document.getElementById("hans").innerHTML += "<span style=\"color: red;\"> Error Loading Data! Please check that GCI_CompleteData2.csv is present in the same directory as this html file.</span>";
            });
        </script>
	</body>
</html>
