<!DOCTYPE html>
<html lang="en">
<style>
    /* Reference: http://bl.ocks.org/d3noob/a22c42db65eb00d4e369 */
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 65px;
        height: 40px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>

<head>
    <meta charset="utf-8">
    <title>Solutions</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<!-- Jonathan and Ernestas body Bootstrap START -->
<body style="background-color: aliceblue">

    <!-- NOTE: Many of the bootstrap components used in this assignment are adaptions from: https://getbootstrap.com/docs/3.3/components/ -->

    <div class="container">
        <div class="jumbotron">
            <h1>Channeling Hans</h1>
            <p>by Jonathan Leon, Xinyue Wang and Ernestas Monkevicius</p>
            <button type="button" class="btn btn-primary btn-lg" data-toggle="collapse" data-target="#queryControl">Learn More</button>
            <br/>
            <div id="queryControl" class="collapse">
                <br/>
                <p>
                    Hans Rosling is a data visualisation legend. His 2006 TED talk, "The Best Stats	
                    Youâ€™ve Ever Seen", is one of the most viewed videos on the TED website.
                </p>
                <p>
                    In this	assignment, Jonathan Leon, Xinyue Wang and Ernestas Monkevicius have been tasked to create	
                    an information visualisations that is an homage	to Hans	Rosling. The result may be viewed below.
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-2">
                <h3 id="year_header" style="margin-top: 0;">Year: 2007</h3>
            </div>
            <div class="col-xs-4">
                <!-- Split button for choosing country and showing it's trace -->
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: black;">Select Country <span class="caret"></span></button>
                    <button type="button" class="btn btn-primary" id="showTraceButton"><span>Show Trace</span></button>
                    <ul class="dropdown-menu">
                    <li><a href="#">Country1</a></li>
                    <li><a href="#">Country2</a></li>
                    <li role="separator" class="divider"></li>
                    <li><a href="#">Country3</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-xs-6">
                <!-- space -->
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h2 id="g1"></h2>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-2">
                <button type="button" class="btn btn-success" id="playPauseButton"><span class="glyphicon glyphicon-play"></span><br/><p>Play</p></button>
            </div>
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-xs-1">
                        <!-- space -->
                    </div>
                    <div class="col-xs-1">
                        2007
                    </div>
                    <div class="col-xs-1">
                        2008
                    </div>
                    <div class="col-xs-1">
                        2009
                    </div>
                    <div class="col-xs-1">
                        2010
                    </div>
                    <div class="col-xs-1">
                        2011
                    </div>
                    <div class="col-xs-1">
                        2012
                    </div>
                    <div class="col-xs-1">
                        2013
                    </div>
                    <div class="col-xs-1">
                        2014
                    </div>
                    <div class="col-xs-1">
                        2015
                    </div>
                    <div class="col-xs-1">
                        2016
                    </div>
                    <div class="col-xs-1">
                        2017
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-1">
                        <!-- space -->
                    </div>
                    <div class="col-xs-11">
                        <div data-role="main" class="ui-content">
                            <form method="post">
                                <label for="yearSlider">Year:</label>
                                <input type="range" name="yearSlider" id="yearSlider" value="2007" min="2007" max="2017">
                            </form>
                        </div>
                    </div>
                </div>
                <br/>
            </div>
        </div>
    </div>
    <!-- Jonathan and Ernestas body Bootstrap END -->

    <script>
        //initial state of the visualization animation
        let playing = false;
        //assigning callbacks to play/pause button
        $( "#playPauseButton" ).on( "click", function() {
            //let rows = $('#...').val();
            playing = !playing;
            if (playing) {
                $( '#playPauseButton' ).addClass('btn-danger').removeClass('btn-success');
                $( '#playPauseButton span' ).addClass('glyphicon-pause').removeClass('glyphicon-play');
                $( '#playPauseButton p' ).text("Pause");
            } else {
                $( '#playPauseButton' ).addClass('btn-success').removeClass('btn-danger');
                $( '#playPauseButton span' ).addClass('glyphicon-play').removeClass('glyphicon-pause');
                $( '#playPauseButton p' ).text("Play");
            }
            console.log("Play/Pause Button state:: is playing? "+playing); //TESTING
        });

        let showingTrace = false;
        //assign callback to show trace button
        $( "#showTraceButton" ).on( "click", function() {
            //let rows = $('#...').val();
            showingTrace = !showingTrace;
            if (showingTrace) {
                $( '#showTraceButton' ).addClass('btn-danger').removeClass('btn-primary');
                //$( '#showTraceButton span' ).addClass('glyphicon-pause').removeClass('glyphicon-play');
                $( '#showTraceButton span' ).text("Hide Trace");

                //showTrace(country, true);
            } else {
                $( '#showTraceButton' ).addClass('btn-primary').removeClass('btn-danger');
                //$( '#showTraceButton span' ).addClass('glyphicon-play').removeClass('glyphicon-pause');
                $( '#showTraceButton span' ).text("Show Trace");

                //showTrace(country, false);
            }
            console.log("Show Trace Button state:: is showing trace? "+showingTrace); //TESTING
        });

         // The year to display
        let display_year = 2007;
        let dataset = {};

        document.getElementById("yearSlider").oninput = function() {
            console.log("Year Slider:: value -> "+this.value); //TESTING
            display_year = +this.value;
            generateVis(dataset);
        };

        //define input file
        let file = "GCI_CompleteData3.csv";

        // Define margins
        var margin = { top: 10, right: 10, bottom: 45, left: 55 };

        //Width and height
        var outer_width = 1100;
        var outer_height = 450;
        var svg_width = outer_width - margin.left - margin.right;
        var svg_height = outer_height - margin.top - margin.bottom;

        // define a function that filters data by year
        function yearFilter(value) {
            return (value.Year == display_year)
        }

        //Create SVG element as a group with the margins transform applied to it
        var svg = d3.select("#g1")
            .append("svg")
            .attr("width", svg_width + margin.left + margin.right)
            .attr("height", svg_height + margin.top + margin.bottom)
            .style("background", "white")
            //.style("width", "80vw")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        //.style("fill", "white");

        //Add legend frame
        // var legend_margin = { top: 10, right: 10, bottom: 10, left: 10 };
        // var rect_width = svg_width*0.2;
        // var rect_height = svg_height*.2;
        // svg.append("rect")
        // .attr("x", svg_width-rect_width)
        // .attr("y", 0)
        // .attr("width", rect_width)
        // .attr("height", rect_height)
        // .style("fill", "lightsteelblue")
        // .style("opacity",.9)
        // ;
        // //Add circles and Text
        // var legend_circle_r = svg_width*0.05;
        // svg.append("circle")
        // .attr("cx", svg_width-rect_width+legend_margin.left)
        // .attr("cy", legend_margin.top)
        // .attr("r", legend_circle_r)
        // .style("fill", "blue")
        // ;

        //-- Wang and Ernestas Main Graph Axes START --//
        // Create linear Y scale for Global Competitive Index
        var yScale = d3.scaleLinear()
            .domain([0, 7])
            .range([svg_height, 0]);

        //Create logarithmic X scale for the GPD
        var xScale = d3.scaleLog()
            .domain([100, 2.4e6])
            .range([0, svg_width]);

        //Define Y axis
        var yAxis = d3.axisLeft()
            .scale(yScale)
            .ticks(5)
            .tickFormat(d3.format(".0s"))
            ;

        // Create an x-axis connected to the x scale
        var xAxis = d3.axisBottom()
            .scale(xScale)
            // .tickFormat(d3.format(".0s"))
            .ticks(10, ".0s")
            ;

        // Define the div for the tooltip
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Call the y axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "y-axis")
            .call(yAxis);

        // All but call the x-axis
        svg.append("g")
            .attr("class", "axis")
            .attr("id", "x-axis")
            .attr("transform", "translate(0," + svg_height + ")")
            .call(xAxis)
            ;

        // text label for the x axis
        svg.append("text")
            .attr("transform",
                "translate(" + (outer_width / 2) + " ," +
                (svg_height + margin.top + 30) + ")")
            .style("text-anchor", "middle")
            .text("GDP");

        // text label for the y axis
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (svg_height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Global Competitive Index");

        //-- Wang and Ernestas Main Graph Axes END --//

        // Define a fucntion to draw a simple bar chart
        //-- Wang and Ernestas Main Graph START --//
        function generateVis(data) {

            // Filter the data to only include the current year
            var filtered_datset = data.filter(yearFilter);

            // Update the domain of the x scale
            //xScale.domain(filtered_datset.map(function(d) { return d.Company; }));

            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            /******** PERFORM DATA JOIN ************/
            // Join new data with old elements, if any.
            /*var bars = 	svg.selectAll("rect")
           .data(filtered_datset, function key(d) {
                                    return d.Company;
                                });*/

            var points = svg.selectAll("circle")
                .data(filtered_datset, function key(d) {
                    return d.Country;
                });

            /******** HANDLE UPDATE SELECTION ************/
            // Update the display of existing elelemnts to match new data
            // Perform a data join and add points to the chart
            points
                .transition()
                .duration(1000)
                .attr("cx", function (d) {
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .attr("r", function (d) {
                    //Divide 90000 since the smallest country's population is so.
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;

                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "green" : "orange";
                })
                .style("stroke", "black")
                ;
            // .on("mouseover", function (d) {
            //     div.transition()
            //         .duration(200)
            //         .style("opacity", .9);
            //     div.html(d.Country)
            //         .style("left", (d3.event.pageX) + "px")
            //         .style("top", (d3.event.pageY - 28) + "px");
            // })
            // .on("mouseout", function (d) {
            //     div.transition()
            //         .duration(500)
            //         .style("opacity", 0);
            // });


            /******** HANDLE ENTER SELECTION ************/
            // Create new elements in the dataset
            // Perform a data join and add points to the chart
            var enter = points.enter()
                .append("circle")
                .attr("cx", function (d) {
                    // console.log(d.GDP);
                    return d.GDP ? xScale(+d.GDP) : margin.left;
                })
                .attr("cy", function (d) {
                    return d.Global_Competitiveness_Index ? yScale(+d.Global_Competitiveness_Index) : svg_height;
                })
                .on("mouseover", function (d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(d.Country + "<br>" + d.Population)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function (d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            enter.transition()
                .duration(1000)
                .ease(d3.easeBounce)
                .attr("r", function (d) {
                    if (d.Population) {
                        let circleArea = Math.sqrt((+d.Population / Math.PI) / 90000);
                        return circleArea;
                    } else return 0;
                })
                .style("fill", function (d) {
                    return d.Global_Competitiveness_Index ? "blue" : "orange";
                })
                .style("stroke", "black");
            //.attr("r", 6);



            /******** HANDLE EXIT SELECTION ************/
            // Remove elements that not longer have a matching data eleement
            points.exit()
                .style("fill", "red")
                .transition()
                .duration(1000)
                .attr("r", 0)
                .remove();

            // Set the year label
            d3.select("#year_header").text("Year: " + display_year);

        }
        //-- Wang and Ernestas Main Graph END --//


        //-- Jonathan and Wang Graph Legend START --//
        //Add legend frame
        var legend_margin = { top: 10, right: 10, bottom: 10, left: 10 };
        var rect_width = svg_width*0.2;
        var rect_height = svg_height*.2;
        var gap = 10;
        svg.append("rect")
        .attr("x", svg_width-rect_width)
        .attr("y", 0)
        .attr("width", rect_width)
        .attr("height", rect_height)
        .style("fill", "lightsteelblue")
        .style("opacity",.9)
        ;

        //Add legend rects and Text
        var legend_circle_r = svg_width*0.01;
        svg.append("rect")
        .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top)
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "blue")
        ;

        svg.append("rect")
        // .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top+gap+legend_circle_r)
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "green")
        ;

        svg.append("rect")
        // .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top+2*(gap+legend_circle_r))
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "orange")
        ;

        svg.append("rect")
        // .attr("id","blue")
        .attr("x", svg_width-rect_width+legend_margin.left)
        .attr("y", legend_margin.top+3*(gap+legend_circle_r))
        .attr("width", legend_circle_r)
        .attr("height", legend_circle_r)
        .style("fill", "red")
        ;

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+10) + ")")
            // .style("text-anchor", "middle")
            .text("New Enter");

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+10+gap+legend_circle_r) + ")")
            // .style("text-anchor", "middle")
            .text("Update");

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+2*(gap+legend_circle_r)+10) + ")")
            // .style("text-anchor", "middle")
            .text("Missing Value");

        svg.append("text")
        .attr("transform",
                "translate(" + (svg_width-rect_width+legend_margin.left+legend_circle_r+gap) + " ," +
                (legend_margin.top+3*(gap+legend_circle_r)+10) + ")")
            // .style("text-anchor", "middle")
            .text("Exiting");
        //-- Jonathan and Wang Graph Legend END --//


        //-- Ernestas and Jonathan File Loading START --//
        // Load the file data.csv and generate a visualisation based on it
        d3.csv(file).then(function (data) {
            console.log(data); //TESTING
            dataset = data;
            //handle the loaded data
            handleData(dataset);
        }, function (error) {
            console.log("Error Loading data!");
            console.log(error);
            document.getElementById("hans").innerHTML += "<span style=\"color: red;\"> Error Loading Data! Please check that "+file+" is present in the same directory as this html file.</span>";
        });

        function handleData(dataset){
            // Update the domain of the x scale
            //xScale.domain(dataset.map(function(d) { return d.GDP; }));
            // Call the x-axis
            svg.select("#x-axis").call(xAxis);

            // Generate the visualisation
            generateVis(dataset);

            //Populate the country drop down
            populateCountryTraceDropdown(dataset);

            // Iterate through our avilable years.


            //setTimeout() runs only ONCE as oppose to setInterval() which loops automatically
            //since we want to control playback ourselves, we can't use setInterval()
            setInterval(function () {

                if(playing){
                    if (display_year > 2017) {
                        display_year = 2007;
                    }
                    generateVis(dataset);

                    document.getElementById("yearSlider").value = display_year;
                    display_year = display_year + 1;
                }
            }, 2000);
        }
        //-- Ernestas and Jonathan File Loading END --//

        function populateCountryTraceDropdown(data){
            //...
        }

    </script>
</body>

</html>